function [mean_difference,mean_resistance,trialdata]=...
    v_clamp(module,recdate,cellnum,trial,starting_v,first_prestep_v,...
    last_prestep_v,increments,step_v,resistance_v,starting_t,prestep_t,step_t,...
    resistance_pulse_t,resistance_pause_t,number_resistance,sample_rate)

warning off all

rtxi_trial_data
% load([module '_' recdate '_' cellnum])

eval(['trialdata=' module '_' recdate '_' cellnum num2str(trial) ';'])

mean_starting=mean(trialdata(1:starting_t*sample_rate,1));

prestep_step=(last_prestep_v-first_prestep_v)/(increments-1)*1000; % in mV

for k=1:increments
    mean_prestep(k)=mean(trialdata((starting_t+(k-1)*(prestep_t+step_t))*sample_rate:...
        (starting_t+(k-1)*(prestep_t+step_t)+prestep_t)*sample_rate,1));
    mean_step(k)=mean(trialdata((starting_t+k*(prestep_t+step_t)-step_t+...
        number_resistance*(resistance_pause_t+resistance_pulse_t))*sample_rate:...
        (starting_t+k*(prestep_t+step_t))*sample_rate,1));
    for h=1:number_resistance
        mean_pulse(k,h)=mean(trialdata((starting_t+k*(prestep_t+step_t)-step_t+...
            (h-1)*(resistance_pause_t+resistance_pulse_t)+resistance_pause_t)*sample_rate:...
            (starting_t+k*(prestep_t+step_t)-step_t+...
            h*(resistance_pause_t+resistance_pulse_t))*sample_rate,1));
        mean_pause(k,h)=mean(trialdata((starting_t+k*(prestep_t+step_t)-step_t+...
            (h-1)*(resistance_pause_t+resistance_pulse_t))*sample_rate:...
            (starting_t+k*(prestep_t+step_t)-step_t+...
            h*(resistance_pause_t+resistance_pulse_t)-resistance_pulse_t)*sample_rate,1));
    end
    mean_difference(k,:)=(mean_pause(k,:)-mean_pulse(k,:))*1e12;
    mean_resistance(k,:)=((step_v-resistance_v)*1000./mean_difference(k,:))*1000; % in megaohms
    resistanceplot=plot(1:5,mean_resistance(k,:),'LineWidth',2);hold on;
    set(resistanceplot,'Color',[1/sqrt(k) 0 1/sqrt(k)]) % darker color = higher k
end

title({'Resistance Increases with Prestep Voltage';[num2str(first_prestep_v*1000)...
    ' to ' num2str(last_prestep_v*1000) ' mV in '...
    num2str((last_prestep_v-first_prestep_v)*1000/(increments-1)) ' mV steps'];...
    ['Step Voltage: ' num2str(step_v*1000) ' mV; darker color = higher prestep voltage']})
xlabel('Pulse number')
ylabel('Resistance [M\Omega]')