function [this_recovery,mean_recovery,max_recovery_pulse,normalized_recovery_pulse,recovery_fit]=...
    recovery_time(module,recdate,cellnum,trial,pulse_V,pulse_t,recovery_V,...
    starting_recovery_t,increments,recovery_pulse_V,recovery_pulse_t,pause_V,pause_t,...
    EK,recovery_pulse_begintimes,recovery_begintimes,sample_rate)

warning off all

load([module '_' recdate '_' cellnum])

eval(['trialdata=' module '_' recdate '_' cellnum num2str(trial) ';'])

mean_starting=mean(trialdata(1:pause_t*sample_rate,1));

conductancedata=trialdata; %conductance values not found during pause periods
total_recovery=0;

for k=1:increments
    this_recovery(k)=starting_recovery_t*2^(k-1);
    total_recovery=total_recovery+this_recovery(k);
    baselinecurrent(k)=mean(trialdata((k*(pause_t+pulse_t+recovery_pulse_t)+total_recovery-...
        (pulse_t+this_recovery(k)+recovery_pulse_t)-(pause_t/10))*sample_rate:...
        (k*(pause_t+pulse_t+recovery_pulse_t)+total_recovery-...
        (pulse_t+this_recovery(k)+recovery_pulse_t))*sample_rate-1,1)*1e12);
    currentzeroeddata((k*(pause_t+pulse_t+recovery_pulse_t)+total_recovery-...
        (pulse_t+this_recovery(k)+recovery_pulse_t))*sample_rate:...
        (k*(pause_t+pulse_t+recovery_pulse_t)+total_recovery)*sample_rate-1,1)=...
        trialdata((k*(pause_t+pulse_t+recovery_pulse_t)+total_recovery-...
        (pulse_t+this_recovery(k)+recovery_pulse_t))*sample_rate:...
        (k*(pause_t+pulse_t+recovery_pulse_t)+total_recovery)*sample_rate-1,1)*1e12-baselinecurrent(k);
    conductancedata((k*(pause_t+pulse_t+recovery_pulse_t)+total_recovery-...
        recovery_pulse_t)*sample_rate:...
        (k*(pause_t+pulse_t+recovery_pulse_t)+total_recovery)*sample_rate-1,1)=...
        currentzeroeddata((k*(pause_t+pulse_t+recovery_pulse_t)+total_recovery-...
        recovery_pulse_t)*sample_rate:...
        (k*(pause_t+pulse_t+recovery_pulse_t)+total_recovery)*sample_rate-1,1)/...
        (recovery_pulse_V-EK); %conductance in nS
    max_recovery_pulse(k)=max(conductancedata((k*(pause_t+pulse_t+recovery_pulse_t)+total_recovery-...
        recovery_pulse_t+recovery_pulse_begintimes(k))*sample_rate:...
        (k*(pause_t+pulse_t+recovery_pulse_t)+total_recovery)*sample_rate-1,1));
    mean_recovery(k)=mean(currentzeroeddata((k*(pause_t+pulse_t+recovery_pulse_t)+total_recovery-...
        (recovery_pulse_t+this_recovery(k))+recovery_begintimes(k))*sample_rate+1:...
        (k*(pause_t+pulse_t+recovery_pulse_t)+total_recovery-recovery_pulse_t)*sample_rate,1));
    snippet_recovery{k}=currentzeroeddata((k*(pause_t+pulse_t+recovery_pulse_t)+total_recovery-...
        (recovery_pulse_t+this_recovery(k)))*sample_rate+1:...
        (k*(pause_t+pulse_t+recovery_pulse_t)+total_recovery-recovery_pulse_t)*sample_rate,1);
    snippet_recovery_pulse(k,:)=currentzeroeddata((k*(pause_t+pulse_t+recovery_pulse_t)+total_recovery-...
        recovery_pulse_t)*sample_rate:(k*(pause_t+pulse_t+recovery_pulse_t)+total_recovery)*sample_rate-1,1);
    
    figure(1);hold on;plot(1/sample_rate:1/sample_rate:numel(snippet_recovery_pulse(k,:))/sample_rate,snippet_recovery_pulse(k,:),'Color',[1/sqrt(k) 0 1/sqrt(k)])
    figure(4);hold on;plot(1/sample_rate:1/sample_rate:numel(snippet_recovery{k})/sample_rate,snippet_recovery{k},'Color',[rand rand rand])
end

normalized_recovery_pulse=max_recovery_pulse/max(max_recovery_pulse);

recovery_fit=nlinfit(this_recovery(10:end),normalized_recovery_pulse(10:end),'activation_expFun',[1 1 1 1]);

figure(2);plot(this_recovery,max_recovery_pulse) % conductance in nS
figure(3);plot(this_recovery,normalized_recovery_pulse)
hold on;plot(this_recovery(10:end),activation_expFun(recovery_fit,this_recovery(10:end)),'g')