clear;clc;%close all

tic

% dates_all={'Oct_03_14' 'Oct_03_14' 'Oct_06_14' 'Oct_06_14' 'Oct_06_14' 'Oct_14_14'...
%     'Oct_14_14'}; % End of hyperpolarized (1 sec pulse, 1 sec pause)
% dates_all={'Oct_28_14' 'Oct_28_14' 'Oct_28_14' 'Oct_28_14' 'Oct_30_14' 'Oct_30_14'...
%     'Nov_26_14' 'Dec_03_14' 'Dec_03_14' 'Dec_08_14' 'Dec_12_14' 'Dec_17_14'...
%     'Dec_19_14' 'Dec_19_14' 'Dec_22_14' 'Dec_22_14' 'Dec_22_14' 'Dec_22_14'...
%     'Dec_22_14' 'Dec_22_14' 'Dec_23_14' 'Dec_23_14' 'Dec_23_14' 'Jan_07_15'...
%     'Jan_07_15' 'Jan_07_15' 'Jan_13_15' 'Jan_13_15' 'Jan_13_15' 'Jan_14_15'...
%     'Jan_14_15' 'Jan_27_15' 'Jan_27_15' 'Feb_03_15' 'Feb_03_15' 'Feb_03_15'...
%     'Feb_10_15' 'Feb_10_15' 'Feb_10_15' 'Mar_03_15' 'Mar_06_15' 'Mar_10_15'...
%     'Mar_10_15' 'Mar_10_15' 'Mar_10_15' 'Mar_10_15' 'Mar_10_15' 'Mar_10_15'...
%     'Mar_10_15' 'Mar_10_15' 'Mar_11_15' 'Mar_11_15' 'Mar_11_15' 'Mar_11_15'...
%     'Mar_11_15' 'Mar_16_15' 'Mar_16_15' 'Mar_16_15' 'Mar_16_15' 'Mar_16_15'...
%     'Mar_16_15' 'Mar_16_15' 'Mar_16_15' 'Mar_16_15' 'Mar_16_15' 'Mar_17_15'...
%     'Mar_17_15' 'Mar_17_15' 'Mar_18_15' 'Mar_18_15' 'Mar_18_15' 'Mar_18_15'...
%     'Mar_18_15' 'Mar_18_15' 'Mar_21_15' 'Mar_21_15' 'Mar_21_15' 'Mar_23_15'...
%     'Mar_23_15' 'Mar_23_15' 'Mar_23_15' 'Mar_23_15' 'Mar_23_15' 'Mar_23_15'...
%     'Mar_23_15' 'Mar_23_15' 'Mar_24_15' 'Mar_24_15' 'Mar_24_15' 'Mar_27_15'...
%     'Mar_27_15' 'Mar_27_15' 'Apr_03_15' 'Apr_03_15' 'Apr_06_15' 'Apr_07_15'...
%     'Apr_07_15' 'Apr_07_15' 'Apr_07_15' 'Apr_07_15' 'Apr_08_15' 'Apr_08_15'...
%     'Apr_08_15' 'Apr_29_15' 'May_01_15' 'May_05_15'}; % End of hyperpolarized (5 sec pulse, 1 sec pause)
% dates_all={'Oct_03_14' 'Oct_03_14' 'Oct_06_14' 'Oct_06_14' 'Oct_06_14' 'Oct_14_14'...
%     'Oct_14_14'}; % End of depolarized (1 sec pulse, 1 sec pause)
% dates_all={'Oct_28_14' 'Oct_30_14' 'Oct_30_14' 'Nov_26_14' 'Nov_26_14' 'Dec_03_14'...
%     'Dec_03_14' 'Dec_08_14' 'Dec_19_14' 'Dec_22_14' 'Dec_22_14' 'Dec_22_14'...
%     'Dec_22_14' 'Dec_22_14' 'Dec_22_14' 'Dec_23_14' 'Dec_23_14' 'Dec_23_14'...
%     'Jan_07_15' 'Jan_07_15' 'Jan_13_15' 'Jan_13_15' 'Jan_13_15' 'Jan_14_15'...
%     'Jan_27_15' 'Jan_27_15' 'Feb_03_15' 'Feb_03_15' 'Feb_03_15' 'Feb_10_15'...
%     'Feb_10_15' 'Feb_10_15' 'Mar_03_15' 'Mar_06_15' 'Mar_10_15' 'Mar_10_15'...
%     'Mar_10_15' 'Mar_10_15' 'Mar_10_15' 'Mar_10_15' 'Mar_10_15' 'Mar_10_15'...
%     'Mar_10_15' 'Mar_11_15' 'Mar_11_15' 'Mar_11_15' 'Mar_11_15' 'Mar_16_15'...
%     'Mar_16_15' 'Mar_16_15' 'Mar_16_15' 'Mar_16_15' 'Mar_16_15' 'Mar_16_15'...
%     'Mar_16_15' 'Mar_16_15' 'Mar_16_15' 'Mar_17_15' 'Mar_17_15' 'Mar_17_15'...
%     'Mar_18_15' 'Mar_18_15' 'Mar_18_15' 'Mar_18_15' 'Mar_21_15' 'Mar_23_15'...
%     'Mar_23_15' 'Mar_23_15' 'Mar_23_15' 'Mar_23_15' 'Mar_23_15' 'Mar_24_15'...
%     'Mar_24_15' 'Mar_24_15' 'Mar_27_15' 'Mar_27_15' 'Apr_03_15' 'Apr_03_15'...
%     'Apr_06_15' 'Apr_07_15' 'Apr_07_15' 'Apr_07_15' 'Apr_08_15' 'Apr_08_15'...
%     'Apr_08_15' 'Apr_29_15' 'May_01_15' 'May_01_15' 'May_05_15'}; % End of depolarized (5 sec pulse, 1 sec pause)
% dates_all={'Oct_24_14' 'Oct_24_14' 'Oct_24_14' 'Oct_24_14' 'Jan_07_15' 'Jan_13_15'...
%     'Jan_14_15' 'Mar_17_15' 'Mar_17_15' 'Mar_18_15' 'Mar_18_15' 'Mar_23_15'...
%     'Mar_23_15' 'Mar_24_15' 'Mar_27_15' 'Apr_07_15'}; % End of hyperpolarized with negative leak
% dates_all={'Oct_23_14' 'Oct_24_14' 'Oct_24_14' 'Oct_24_14' 'Oct_28_14' 'Oct_30_14'...
%     'Oct_30_14' 'Oct_30_14' 'Nov_26_14' 'Jan_07_15' 'Jan_07_15' 'Mar_17_15'...
%     'Mar_18_15' 'Mar_18_15' 'Mar_23_15' 'Mar_23_15' 'Mar_24_15' 'Mar_24_15'...
%     'Mar_27_15' 'Apr_06_15' 'Apr_07_15' 'Apr_07_15' 'Apr_07_15'}; % End of depolarized with leak
% dates_all={'Sep_16_14' 'Sep_16_14' 'Sep_19_14' 'Sep_19_14' 'Sep_23_14' 'Sep_23_14'... % don't use 'Sep_19_14_C' in the average
%     'Oct_24_14' 'Oct_24_14' 'Oct_30_14' 'Nov_26_14' 'Nov_26_14' 'Nov_26_14'...
%     'Dec_08_14' 'Dec_19_14' 'Dec_19_14' 'Dec_19_14' 'Dec_22_14' 'Dec_22_14'...
%     'Dec_22_14' 'Dec_22_14' 'Dec_22_14' 'Dec_22_14' 'Dec_22_14' 'Dec_22_14'...
%     'Dec_22_14' 'Dec_22_14' 'Dec_22_14' 'Dec_23_14' 'Dec_23_14' 'Dec_23_14'...
%     'Dec_23_14' 'Dec_23_14' 'Dec_23_14'}; % End of hyperpolarized with current subtracted
% dates_all={'Mar_24_15' 'Mar_24_15' 'Mar_27_15' 'Mar_27_15' 'Mar_27_15' 'Mar_28_15'...
%     'Mar_28_15' 'Mar_28_15' 'Mar_28_15' 'Mar_30_15' 'Mar_30_15' 'Mar_30_15'...
%     'Mar_30_15' 'Apr_10_15' 'Apr_10_15' 'Apr_10_15' 'Apr_10_15' 'May_05_15'...
%     'May_05_15' 'May_05_15' 'May_05_15'}; % End of hyperpolarized non-cholinergic neurons
% dates_all={'Mar_24_15' 'Mar_24_15' 'Mar_27_15' 'Mar_27_15' 'Mar_28_15' 'Mar_28_15'...
%     'Mar_28_15' 'Mar_30_15' 'Mar_30_15' 'Mar_30_15' 'Apr_10_15' 'Apr_10_15'...
%     'Apr_10_15' 'Apr_10_15' 'May_05_15' 'May_05_15' 'May_05_15' 'May_05_15'}; % End of depolarized non-cholinergic neurons
% dates_all={'Apr_29_15' 'May_01_15' 'May_04_15' 'May_05_15' 'May_05_15' 'May_05_15'...
%     'May_05_15' 'May_05_15'}; % End of hyperpolarized with 4-AP (5 sec pulse, 1 sec pause)
% dates_all={'Apr_29_15' 'May_01_15' 'May_04_15' 'May_05_15' 'May_05_15' 'May_05_15'...
%     'May_05_15'}; % End of depolarized with 4-AP (5 sec pulse, 1 sec pause)
dates_all={'Feb_10_15' 'Mar_10_15' 'Mar_10_15' 'Mar_11_15' 'Mar_16_15' 'Mar_16_15' 'Feb_10_15' 'Mar_10_15' 'Mar_10_15' 'Mar_11_15' 'Mar_17_15' 'Mar_23_15' 'Apr_07_15'...
    'Mar_17_15' 'Mar_23_15' 'Mar_24_15' 'Apr_06_15' 'Apr_07_15'}; % End of hyperpolarized with noise
% dates_all={'Feb_10_15' 'Mar_10_15' 'Mar_10_15' 'Mar_11_15' 'Mar_16_15' 'Mar_16_15' 'Feb_10_15' 'Mar_10_15' 'Mar_10_15' 'Mar_11_15' 'Mar_17_15' 'Mar_23_15' 'Apr_07_15'...
%     'Mar_17_15' 'Mar_23_15' 'Mar_24_15' 'Apr_06_15' 'Apr_07_15'}; % End of depolarized with noise

% cellnum_all={'A' 'B' 'A' 'B' 'C' 'A'...
%     'B'}; % End of hyperpolarized (1 sec pulse, 1 sec pause)
% cellnum_all={'A' 'B' 'C' 'C' 'A' 'B'...
%     'A' 'A' 'B' 'A' 'A' 'A'...
%     'A' 'A' 'A' 'B' 'C' 'D'...
%     'D' 'E' 'A' 'B' 'C' 'A'...
%     'B' 'B' 'A' 'B' 'C' 'A'...
%     'A' 'A' 'B' 'A' 'B' 'C'...
%     'A' 'B' 'C' 'A' 'A' 'A'...
%     'A' 'A' 'B' 'B' 'C' 'C'...
%     'C' 'D' 'A' 'B' 'B' 'C'...
%     'C' 'A' 'A' 'B' 'B' 'B'...
%     'B' 'C' 'C' 'D' 'D' 'A'...
%     'A' 'B' 'A' 'A' 'A' 'A'...
%     'B' 'B' 'A' 'A' 'A' 'A'...
%     'A' 'B' 'B' 'B' 'C' 'C'...
%     'D' 'E' 'A' 'B' 'B' 'A'...
%     'A' 'A' 'B' 'B' 'B' 'A'...
%     'A' 'A' 'C' 'D' 'C' 'D'...
%     'E' 'E' 'C' 'D'}; % End of hyperpolarized (5 sec pulse, 1 sec pause)
% cellnum_all={'A' 'B' 'A' 'B' 'C' 'A'...
%     'B'}; % End of depolarized (1 sec pulse, 1 sec pause)
% cellnum_all={'A' 'A' 'B' 'A' 'A' 'A'...
%     'B' 'A' 'A' 'A' 'A' 'B'...
%     'C' 'D' 'D' 'A' 'B' 'C'...
%     'A' 'B' 'A' 'B' 'C' 'A'...
%     'A' 'B' 'A' 'B' 'C' 'A'...
%     'B' 'C' 'A' 'A' 'A' 'A'...
%     'A' 'B' 'B' 'C' 'C' 'C'...
%     'D' 'A' 'B' 'B' 'C' 'A'...
%     'A' 'B' 'B' 'B' 'B' 'C'...
%     'C' 'D' 'D' 'A' 'A' 'B'...
%     'A' 'A' 'B' 'B' 'A' 'B'...
%     'B' 'C' 'C' 'D' 'E' 'A'...
%     'B' 'B' 'A' 'A' 'B' 'B'...
%     'B' 'A' 'C' 'D' 'C' 'D'...
%     'E' 'E' 'C' 'C' 'D'}; % End of depolarized (5 sec pulse, 1 sec pause)
% cellnum_all={'A' 'A' 'B' 'B' 'B' 'A'...
%     'A' 'A' 'A' 'A' 'A' 'B'...
%     'C' 'B' 'A' 'D'}; % End of hyperpolarized with negative leak
% cellnum_all={'A' 'A' 'A' 'B' 'A' 'A'...
%     'A' 'B' 'A' 'A' 'B' 'A'...
%     'A' 'B' 'B' 'E' 'A' 'B'...
%     'A' 'B' 'A' 'C' 'D'}; % End of depolarized with leak
% cellnum_all={'A' 'B' 'A' 'C' 'A' 'B'...
%     'B' 'B' 'A' 'A' 'A' 'A'...
%     'A' 'A' 'A' 'A' 'B' 'B'...
%     'B' 'C' 'C' 'C' 'C' 'C'...
%     'D' 'D' 'D' 'A' 'A' 'B'...
%     'B' 'C' 'C'}; % End of hyperpolarized with current subtracted
% cellnum_all={'C' 'C' 'B' 'B' 'B' 'B'...
%     'B' 'C' 'C' 'A' 'B' 'B'...
%     'C' 'A' 'A' 'A' 'C' 'A'...
%     'B' 'C' 'C'}; % End of hyperpolarized non-cholinergic neurons
% cellnum_all={'C' 'C' 'B' 'B' 'B' 'C'...
%     'C' 'A' 'B' 'C' 'A' 'A'...
%     'A' 'C' 'A' 'B' 'C' 'C'}; % End of depolarized non-cholinergic neurons
% cellnum_all={'E' 'C' 'C' 'D' 'E' 'E'...
%     'F' 'F'}; % End of hyperpolarized with 4-AP (5 sec pulse, 1 sec pause)
% cellnum_all={'E' 'C' 'C' 'E' 'E' 'F'...
%     'F'}; % End of depolarized with 4-AP (5 sec pulse, 1 sec pause)
cellnum_all={'B' 'A' 'D' 'B' 'B' 'C' 'C' 'B' 'C' 'A' 'B' 'C' 'A'...
    'A' 'E' 'B' 'B' 'C'}; % End of hyperpolarized with noise
% cellnum_all={'B' 'A' 'D' 'B' 'B' 'C' 'C' 'B' 'C' 'A' 'B' 'C' 'A'...
%     'A' 'E' 'B' 'B' 'C'}; % End of depolarized with noise

% trials_all=[1 1 1 1 1 1 ...
%     1]'; % End of hyperpolarized (1 sec pulse, 1 sec pause)
% trials_all=[1 1 1 2 1 1 ...
%     1 1 1 1 1 1 ...
%     1 6 1 1 1 1 ...
%     3 1 1 1 1 1 ...
%     1 5 1 1 1 1 ...
%     4 1 1 1 1 1 ...
%     1 1 1 1 1 1 ...
%     3 5 1 3 1 3 ...
%     5 1 1 1 3 1 ...
%     3 1 3 1 3 5 ...
%     7 1 3 1 3 1 ...
%     3 1 1 2 4 5 ...
%     1 3 1 2 3 1 ...
%     2 1 3 4 1 3 ...
%     1 1 1 1 3 1 ...
%     3 4 4 6 5 3 ...
%     4 5 5 3 3 6 ...
%     4 1 1 1]'; % End of hyperpolarized (5 sec pulse, 1 sec pause)
% trials_all=[2 2 2 2 2 2 ...
%     2]'; % End of depolarized (1 sec pulse, 1 sec pause)
% trials_all=[2 2 2 2 7 2 ...
%     2 2 2 2 3 2 ...
%     2 2 4 2 2 2 ...
%     2 2 2 2 2 2 ...
%     2 2 2 2 2 2 ...
%     2 2 2 2 2 4 ...
%     6 2 4 2 4 6 ...
%     2 2 2 4 2 2 ...
%     4 2 4 6 8 2 ...
%     4 2 4 2 4 2 ...
%     3 6 2 4 4 2 ...
%     5 2 4 2 2 2 ...
%     2 4 2 5 5 7 ...
%     6 6 6 4 4 7 ...
%     5 2 2 3 2]'; % End of depolarized (5 sec pulse, 1 sec pause)
% trials_all=[5 6 4 5 4 3 ...
%     3 6 7 8 9 7 ...
%     5 6 7 6]'; % End of hyperpolarized with negative leak
% trials_all=[3 3 4 3 3 3 ...
%     4 3 3 3 3 5 ...
%     7 5 6 3 3 5 ...
%     6 7 7 7 5]'; % End of depolarized with leak
% trials_all=[3 3 4 4 5 4 ...
%     6 7 5 4 5 6 ...
%     3 3 4 5 3 4 ...
%     5 3 4 5 6 7 ...
%     5 6 7 3 4 3 ...
%     4 3 4]'; % End of hyperpolarized with current subtracted
% trials_all=[1 3 1 2 4 1 ...
%     2 1 3 1 1 2 ...
%     1 3 5 7 4 1 ...
%     1 1 3]'; % End of hyperpolarized non-cholinergic neurons
% trials_all=[2 4 3 5 3 2 ...
%     4 2 3 2 4 6 ...
%     8 5 2 2 2 4]'; % End of depolarized non-cholinergic neurons
% trials_all=[7 9 8 3 1 3 ...
%     1 3]'; % End of hyperpolarized with 4-AP (5 sec pulse, 1 sec pause)
% trials_all=[8 10 9 2 4 2 ...
%     4]'; % End of depolarized with 4-AP (5 sec pulse, 1 sec pause)
trials_all=[1 3 1 3 5 1  1 1 1 1 1 1 1 ...
    1 1 3 1 1]'; % End of hyperpolarized with noise
% trials_all=[2 4 2 4 6 2  2 2 2 2 2 2 2 ...
%     2 2 4 2 2]'; % End of depolarized with noise

points_all=repmat([1 21],size(trials_all));
%     [%6 20;10 20;8 20;1 20;6 20;14 20;...
%     5 20;9 20;9 20;6 20;1 20;18 20;...
%     14 20;17 20;13 20;12 20;10 20;10 20;...
%     1 20;1 20;1 20;1 20;1 20;1 20;...
%     1 20;1 20;1 20;1 20;1 20;1 20;...
%     1 20;1 20;1 20;1 20;1 20;1 20;...
%     1 20;1 20;1 20;];... % End of hyperpolarized (5 sec pulse, 1 sec pause)
%     1 20;1 20;1 20;1 20;1 20;1 20;...
%     1 20;1 20;1 20;1 20;1 20;1 20;...
%     1 20;1 20;1 20;1 20;1 20;1 20;...
%     1 20;1 20;1 20;1 20;1 20;1 20;...
%     1 20;1 20;1 20;1 20;1 20;1 20;...
%     1 20;1 20;1 20;];... % End of depolarized (5 sec pulse, 1 sec pause)
%     2 12;2 20;2 7;2 7;3 17;12 20;...
%     12 19;];... % End of hyperpolarized with negative leak
%     10 18;10 15;2 9;17 21;13 21;11 18;...
%     11 19;12 21;8 15;6 12;11 13;];... % End of depolarized with leak
%     7 20;7 19;9 19;5 13;5 14;11 15;...
%     1 20;1 20;4 10;1 20;1 20;1 20;...
%     3 13;4 11;4 10;4 9;11 20;6 20;...
%     7 20;3 9;1 20;1 20;3 8;1 20;...
%     5 15;9 16;1 20;1 20;1 20;9 20;...
%     13 20;13 20;12 20;]; % End of hyperpolarized with current subtracted

parameters_all_up=repmat([-67.9685 8.4820 0.0587],size(trials_all));
parameters_all_down=repmat([-50 20 0],size(trials_all));
%hyperpolarized ChAT
% parameters_all_up(11,:)=[100 100 -1];
% parameters_all_up(29,:)=[100 100 -1];
% parameters_all_up(64,:)=[100 100 -1];
% parameters_all_up(77,:)=[100 100 -1];
%depolarized ChAT
% parameters_all_down(32,:)=[-40 20 0];
% parameters_all_down(87,:)=[-80 0 -100];
%hyperpolarized non-ChAT
%depolarized non-ChAT

noise=1;

if noise~=1
    for k=1:numel(dates_all)
        recdate=dates_all{k};
        cellnum=cellnum_all{k};
        module='fi_curves';
        % trials=1:numel(whos)-3;
        trials=trials_all(k,:);
        parameters_up=parameters_all_up(k,:);
        parameters_down=parameters_all_down(k,:);
        points=points_all(k,:);
        sample_rate=10000;   % Sample rate in Hz
        shouldplotFI=0; % Should the function plot the F-I curves? 1 for yes, 0 for no.
        saveit=0;
        
        [rate_all,peakrate,nofailrate,mean_holdingvoltage,... mean_r_m,std_r_m,mean_time_constant,std_time_constant,mean_c_m,std_c_m,
            numberspikes,thresholds,imp,pulse_duration,pause_duration,delay,increments,currents,...
            pf_all,std_noise,noise_V,mean_spikeform,frequencyforms,ISIs_all,ISIs,ISIratio,firstISI,lastISI,...
            mean_freq0_spikeforms_increment,mean_freq1_spikeforms_increment,...
            mean_freq2_spikeforms_increment,mean_freq3_spikeforms_increment,mean_freq4_spikeforms_increment,...
            mean_freq5_spikeforms_increment,mean_freq6_spikeforms_increment,mean_freq7_spikeforms_increment,...
            mean_freq8_spikeforms_increment,mean_freq9_spikeforms_increment,mean_freq10_spikeforms_increment,...
            mean_freq0_outputforms_increment,mean_freq1_outputforms_increment,...
            mean_freq2_outputforms_increment,mean_freq3_outputforms_increment,mean_freq4_outputforms_increment,...
            mean_freq5_outputforms_increment,mean_freq6_outputforms_increment,mean_freq7_outputforms_increment,...
            mean_freq8_outputforms_increment,mean_freq9_outputforms_increment,mean_freq10_outputforms_increment,...
            mean_lastspikeforms_increment,mean_lastoutputforms_increment,ahp_depth,ahp_duration,...
            first_spike_delay,interspike_voltage,resistance_voltage2,resistance_voltage1,r_m,c_m,mean_r_m,mean_time_constant,mean_c_m,ahp_depth_increment,ahp_duration_increment]=...
            fi_rate_leak_and_subtraction(module,recdate,cellnum,trials,parameters_up,parameters_down,points,sample_rate,shouldplotFI);
        
        %     segmenter(module,recdate,cellnum,trials,delay,pulse_duration,pause_duration,increments,10000,1)
        
        if saveit~=0
            save([pwd '\..\..\F_I_curves\data\fi_analysis\' module '_' recdate '_' cellnum num2str(trials) '_fi'],'rate_all','peakrate','nofailrate','mean_holdingvoltage',... ,'mean_r_m','std_r_m'
                'thresholds','imp','pulse_duration',... 'mean_time_constant','std_time_constant','mean_c_m','std_c_m',
                'pause_duration','delay','increments','currents','pf_all','std_noise','noise_V','mean_spikeform','frequencyforms',...
                'ISIs_all','ISIs','ISIratio','firstISI','lastISI',...
                'mean_freq0_spikeforms_increment','mean_freq1_spikeforms_increment',...
                'mean_freq2_spikeforms_increment','mean_freq3_spikeforms_increment','mean_freq4_spikeforms_increment',...
                'mean_freq5_spikeforms_increment','mean_freq6_spikeforms_increment','mean_freq7_spikeforms_increment',...
                'mean_freq8_spikeforms_increment','mean_freq9_spikeforms_increment','mean_freq10_spikeforms_increment',...
                'mean_freq0_outputforms_increment','mean_freq1_outputforms_increment',...
                'mean_freq2_outputforms_increment','mean_freq3_outputforms_increment','mean_freq4_outputforms_increment',...
                'mean_freq5_outputforms_increment','mean_freq6_outputforms_increment','mean_freq7_outputforms_increment',...
                'mean_freq8_outputforms_increment','mean_freq9_outputforms_increment','mean_freq10_outputforms_increment',...
                'mean_lastspikeforms_increment','mean_lastoutputforms_increment','ahp_depth','ahp_duration',...
                'first_spike_delay','interspike_voltage','resistance_voltage2','resistance_voltage1','r_m','c_m','mean_r_m','mean_time_constant','mean_c_m','ahp_depth_increment','ahp_duration_increment')
        end
    end
    
    for k=1:numel(dates_all)
        recdate=dates_all{k};
        cellnum=cellnum_all{k};
        module='fi_curves';
        % trials=1:numel(whos)-3;
        trials=trials_all(k,:);
        points=points_all(k,:);
        sample_rate=10000;   % Sample rate in Hz
        shouldplotFV=0; % Should the function plot the F-I curves? 1 for yes, 0 for no.
        saveit=0;
        
        clear('rate_all','numberspikes','imp','pulse_duration','pause_duration','delay','increments','currents','pf_all');
        
        [rate_all,numberspikes,imp,pulse_duration,pause_duration,delay,increments,currents,pf_all,threshold,avg_voltage,avg_voltage_trunc,pf_supra_iv]=...
            fV_rate_leak_and_subtraction(module,recdate,cellnum,trials,points,sample_rate,shouldplotFV);
        
        if saveit~=0
            save([pwd '\..\..\F_I_curves\data\fV_analysis\' module '_' recdate '_' cellnum num2str(trials) '_fV'],'rate_all','imp','pulse_duration',...
                'pause_duration','delay','increments','currents','pf_all','threshold','avg_voltage','avg_voltage_trunc','pf_supra_iv')
        end
    end
else
    for k=1:numel(dates_all)
        recdate=dates_all{k};
        cellnum=cellnum_all{k};
        module='FI_OU';
        % trials=1:numel(whos)-3;
        trials=trials_all(k,:);
        parameters_up=parameters_all_up(k,:);
        parameters_down=parameters_all_down(k,:);
        points=points_all(k,:);
        sample_rate=10000;   % Sample rate in Hz
        shouldplotFI=0; % Should the function plot the F-I curves? 1 for yes, 0 for no.
        saveit=0;
        
        cd([pwd '\..\..\F_I_curves\data\'])
        
        [rate_all,peakrate,nofailrate,mean_holdingvoltage,... mean_r_m,std_r_m,mean_time_constant,std_time_constant,mean_c_m,std_c_m,
            numberspikes,thresholds,imp,pulse_duration,pause_duration,delay,increments,currents,...
            pf_all,std_noise,noise_V,mean_spikeform,frequencyforms,ISIs_all,ISIs,ISIratio,firstISI,lastISI,...
            std_noise_all,mean_freq0_spikeforms_increment,mean_freq1_spikeforms_increment,...
            mean_freq2_spikeforms_increment,mean_freq3_spikeforms_increment,mean_freq4_spikeforms_increment,...
            mean_freq5_spikeforms_increment,mean_freq6_spikeforms_increment,mean_freq7_spikeforms_increment,...
            mean_freq8_spikeforms_increment,mean_freq9_spikeforms_increment,mean_freq10_spikeforms_increment,...
            mean_freq0_outputforms_increment,mean_freq1_outputforms_increment,...
            mean_freq2_outputforms_increment,mean_freq3_outputforms_increment,mean_freq4_outputforms_increment,...
            mean_freq5_outputforms_increment,mean_freq6_outputforms_increment,mean_freq7_outputforms_increment,...
            mean_freq8_outputforms_increment,mean_freq9_outputforms_increment,mean_freq10_outputforms_increment,...
            mean_lastspikeforms_increment,mean_lastoutputforms_increment,ahp_depth,ahp_duration,...
            first_spike_delay,interspike_voltage,resistance_voltage2,resistance_voltage1,r_m,c_m,mean_r_m,mean_time_constant,mean_c_m,ahp_depth_increment,ahp_duration_increment]=...
            fi_rate_leak_and_subtraction(module,recdate,cellnum,trials,parameters_up,parameters_down,points,sample_rate,shouldplotFI,noise);
        
        cd([pwd '\..\..\F_I_curves\data\'])
        
            segmenter(module,recdate,cellnum,trials,delay,pulse_duration,pause_duration,increments,10000,1,noise)
        
        if saveit~=0
            save([pwd '\..\..\FI_OU\data\fi_analysis\' module '_' recdate '_' cellnum num2str(trials) '_fi'],'rate_all','peakrate','nofailrate','mean_holdingvoltage',... ,'mean_r_m','std_r_m'
                'thresholds','imp','pulse_duration',... 'mean_time_constant','std_time_constant','mean_c_m','std_c_m',
                'pause_duration','delay','increments','currents','pf_all','std_noise','noise_V','mean_spikeform','frequencyforms',...
                'ISIs_all','ISIs','ISIratio','firstISI','lastISI',...
                'std_noise_all','mean_freq0_spikeforms_increment','mean_freq1_spikeforms_increment',...
                'mean_freq2_spikeforms_increment','mean_freq3_spikeforms_increment','mean_freq4_spikeforms_increment',...
                'mean_freq5_spikeforms_increment','mean_freq6_spikeforms_increment','mean_freq7_spikeforms_increment',...
                'mean_freq8_spikeforms_increment','mean_freq9_spikeforms_increment','mean_freq10_spikeforms_increment',...
                'mean_freq0_outputforms_increment','mean_freq1_outputforms_increment',...
                'mean_freq2_outputforms_increment','mean_freq3_outputforms_increment','mean_freq4_outputforms_increment',...
                'mean_freq5_outputforms_increment','mean_freq6_outputforms_increment','mean_freq7_outputforms_increment',...
                'mean_freq8_outputforms_increment','mean_freq9_outputforms_increment','mean_freq10_outputforms_increment',...
                'mean_lastspikeforms_increment','mean_lastoutputforms_increment','ahp_depth','ahp_duration',...
                'first_spike_delay','interspike_voltage','resistance_voltage2','resistance_voltage1','r_m','c_m','mean_r_m','mean_time_constant','mean_c_m','ahp_depth_increment','ahp_duration_increment')
        end
    end
    
    for k=1:numel(dates_all)
        recdate=dates_all{k};
        cellnum=cellnum_all{k};
        module='FI_OU';
        % trials=1:numel(whos)-3;
        trials=trials_all(k,:);
        points=points_all(k,:);
        sample_rate=10000;   % Sample rate in Hz
        shouldplotFV=0; % Should the function plot the F-I curves? 1 for yes, 0 for no.
        saveit=0;
        
        clear('rate_all','numberspikes','imp','pulse_duration','pause_duration','delay','increments','currents','pf_all');
        
        cd([pwd '\..\..\F_I_curves\data\'])
        
        [rate_all,numberspikes,imp,pulse_duration,pause_duration,delay,increments,currents,pf_all,threshold,avg_voltage,avg_voltage_trunc,pf_supra_iv]=...
            fV_rate_leak_and_subtraction(module,recdate,cellnum,trials,points,sample_rate,shouldplotFV,noise);
        
        if saveit~=0
            save([pwd '\..\..\FI_OU\data\fV_analysis\' module '_' recdate '_' cellnum num2str(trials) '_fV'],'rate_all','imp','pulse_duration',...
                'pause_duration','delay','increments','currents','pf_all','threshold','avg_voltage','avg_voltage_trunc','pf_supra_iv')
        end
    end
end

% close all

toc